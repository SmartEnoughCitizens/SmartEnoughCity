name: CD - Deploy to Production

on:
  push:
    branches: [ci]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

env:
  AWS_REGION: us-east-1  # Change to your AWS region
  EKS_CLUSTER_NAME: smart-enough-city-cluster  # Change to your EKS cluster name
  HELM_RELEASE_NAME: smart-enough-city
  HELM_NAMESPACE: production
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://your-app-url.com  # Update with your actual URL
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ============================================
      # AWS Authentication
      # ============================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # ============================================
      # EKS Cluster Access
      # ============================================
      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}
      
      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      # ============================================
      # Setup Helm
      # ============================================
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'
      
      - name: Add Bitnami Helm repository
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update
      
      # ============================================
      # Create namespace if it doesn't exist
      # ============================================
      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.HELM_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      
      # ============================================
      # Setup GHCR authentication for Kubernetes
      # ============================================
      - name: Create image pull secret for GHCR
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=${{ env.HELM_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
      
      # ============================================
      # Package Helm dependencies
      # ============================================
      - name: Update Helm dependencies
        working-directory: ./helm-charts
        run: |
          helm dependency update
      
      # ============================================
      # Deploy with Helm
      # ============================================
      - name: Deploy to EKS with Helm
        working-directory: ./helm-charts
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} . \
            --namespace ${{ env.HELM_NAMESPACE }} \
            --create-namespace \
            --set data-handler.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/data-handler \
            --set data-handler.image.tag=sha-${{ github.sha }} \
            --set inference-engine.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/inference-engine \
            --set inference-engine.image.tag=sha-${{ github.sha }} \
            --set frontend.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend \
            --set frontend.image.tag=sha-${{ github.sha }} \
            --set global.imagePullSecrets[0].name=ghcr-secret \
            --set postgresql.enabled=true \
            --wait \
            --timeout 10m \
            --atomic \
            --debug
      
      # ============================================
      # Verify Deployment
      # ============================================
      - name: Verify deployment
        run: |
          echo "Checking deployment status..."
          kubectl get all -n ${{ env.HELM_NAMESPACE }}
          
          echo "Checking pod status..."
          kubectl get pods -n ${{ env.HELM_NAMESPACE }} -o wide
          
          echo "Checking services..."
          kubectl get services -n ${{ env.HELM_NAMESPACE }}
      
      - name: Wait for pods to be ready
        run: |
          kubectl wait --for=condition=ready pod \
            --all \
            --namespace=${{ env.HELM_NAMESPACE }} \
            --timeout=300s
      
      # ============================================
      # Health Checks
      # ============================================
      - name: Run health checks
        run: |
          # Get the LoadBalancer URL for frontend
          FRONTEND_URL=$(kubectl get service smart-enough-city-frontend \
            -n ${{ env.HELM_NAMESPACE }} \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          echo "Frontend URL: http://$FRONTEND_URL"
          
          # Wait for LoadBalancer to be ready
          sleep 30
          
          # Basic health check
          if [ ! -z "$FRONTEND_URL" ]; then
            echo "Testing frontend endpoint..."
            curl -f http://$FRONTEND_URL || echo "Frontend not responding yet"
          fi
      
      # ============================================
      # Deployment Summary
      # ============================================
      - name: Generate deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster**: ${{ env.EKS_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ env.HELM_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: ${{ env.HELM_RELEASE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Images" >> $GITHUB_STEP_SUMMARY
          echo "- Hermes: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/hermes:sha-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Inference Engine: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/inference-engine:sha-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:sha-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Data Handler: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/data-handler:sha-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# View pods" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n ${{ env.HELM_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n ${{ env.HELM_NAMESPACE }} -l app=inference-engine" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback if needed" >> $GITHUB_STEP_SUMMARY
          echo "helm rollback ${{ env.HELM_RELEASE_NAME }} -n ${{ env.HELM_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      # ============================================
      # Rollback on Failure
      # ============================================
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed! Rolling back..."
          helm rollback ${{ env.HELM_RELEASE_NAME }} \
            --namespace ${{ env.HELM_NAMESPACE }} \
            --wait
          
          echo "## âŒ Deployment Failed - Rolled Back" >> $GITHUB_STEP_SUMMARY
          echo "The deployment was automatically rolled back to the previous version." >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "Deployment to production successful!"
            # Add Slack/Discord/Email notification here
          else
            echo "Deployment to production failed!"
            # Add failure notification here
          fi