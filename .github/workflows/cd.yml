name: CD (Build + Deploy to GKE)

on:
  push:
    branches: [AIP-27-Add-deployment-pipeline]

concurrency:
  group: cd-main
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  # This becomes "<org>/<repo>"
  IMAGE_BASE: smartenoughcitizens/smartenoughcity

  # GKE / Deploy settings
  GCP_PROJECT_ID: smart-enough-city-dev
  GKE_CLUSTER: smart-enough-city
  GKE_LOCATION: europe-west1-b

  # Helm release settings
  K8S_NAMESPACE: dev
  HELM_RELEASE: sec
  HELM_VALUES_FILE: helm-charts/values-prod.yaml
  CHART_DIR: helm-charts

  # GitHub OIDC -> GCP Workload Identity
  # Put the full provider resource name here
  WORKLOAD_IDENTITY_PROVIDER: projects/946066538527/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  # Put the Service Account email here
  GCP_SERVICE_ACCOUNT: github-deployer@smart-enough-city-dev.iam.gserviceaccount.com

jobs:
  detect-changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      hermes: ${{ steps.filter.outputs.hermes }}
      inference: ${{ steps.filter.outputs.inference }}
      datahandler: ${{ steps.filter.outputs.datahandler }}
      helmchart: ${{ steps.filter.outputs.helmchart }}
    steps:
      - uses: actions/checkout@v4

      - name: Filter paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
            hermes:
              - 'backend/hermes/**'
            inference:
              - 'backend/inference_engine/**'
            datahandler:
              - 'backend/data_handler/**'
            helmchart:
              - 'Chart.yaml'
              - 'Chart.lock'
              - 'values*.yaml'
              - 'templates/**'
              - 'charts/**'

  build-and-push:
    name: Build & push changed images (GHCR)
    runs-on: ubuntu-latest
    needs: [detect-changes]
    permissions:
      contents: read
      packages: write
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute image tag (short SHA)
        id: tag
        run: echo "tag=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Frontend
      - name: Build & push frontend
        if: needs.detect-changes.outputs.frontend == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/frontend:${{ steps.tag.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/frontend:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      # Hermes
      - name: Build & push hermes
        if: needs.detect-changes.outputs.hermes == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./backend/hermes
          file: ./backend/hermes/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/hermes:${{ steps.tag.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/hermes:latest
          cache-from: type=gha,scope=hermes
          cache-to: type=gha,mode=max,scope=hermes

      # Inference Engine
      - name: Build & push inference-engine
        if: needs.detect-changes.outputs.inference == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./backend/inference_engine
          file: ./backend/inference_engine/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/inference-engine:${{ steps.tag.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/inference-engine:latest
          cache-from: type=gha,scope=inference-engine
          cache-to: type=gha,mode=max,scope=inference-engine

      # Data Handler
      - name: Build & push data-handler
        if: needs.detect-changes.outputs.datahandler == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./backend/data_handler
          file: ./backend/data_handler/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/data-handler:${{ steps.tag.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/data-handler:latest
          cache-from: type=gha,scope=data-handler
          cache-to: type=gha,mode=max,scope=data-handler

  deploy:
    name: Helm deploy to GKE (dev)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Helm repo add + dependency build
        run: |
          set -euo pipefail
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update
          helm dependency build helm-charts

      - name: Helm upgrade (set tags only for changed services)
        env:
          TAG: ${{ needs.build-and-push.outputs.tag }}
          FRONTEND_CHANGED: ${{ needs.detect-changes.outputs.frontend }}
          HERMES_CHANGED: ${{ needs.detect-changes.outputs.hermes }}
          INFERENCE_CHANGED: ${{ needs.detect-changes.outputs.inference }}
          DATAHANDLER_CHANGED: ${{ needs.detect-changes.outputs.datahandler }}
          HELM_CHANGED: ${{ needs.detect-changes.outputs.helmchart }}
        run: |
          set -euo pipefail

          # If only Helm/chart changed, we still deploy (no image rebuild required).
          # If nothing changed (rare on push), still deploy is harmless but you can skip.

          ARGS=()
          if [ "$FRONTEND_CHANGED" = "true" ]; then
            ARGS+=("--set" "frontend.image.tag=$TAG")
          fi
          if [ "$HERMES_CHANGED" = "true" ]; then
            ARGS+=("--set" "hermes.image.tag=$TAG")
          fi
          if [ "$INFERENCE_CHANGED" = "true" ]; then
            ARGS+=("--set" "inference-engine.image.tag=$TAG")
          fi
          if [ "$DATAHANDLER_CHANGED" = "true" ]; then
            ARGS+=("--set" "data-handler.image.tag=$TAG")
          fi

          helm upgrade --install "${HELM_RELEASE}" "${CHART_DIR}" \
            -n "${K8S_NAMESPACE}" \
            -f "${HELM_VALUES_FILE}" \
            --wait \
            --timeout 15m \
            "${ARGS[@]}"

      - name: Post-deploy quick checks
        run: |
          kubectl -n "${K8S_NAMESPACE}" get pods
          kubectl -n "${K8S_NAMESPACE}" get ingress "${HELM_RELEASE}-ingress" -o wide