name: CI Pipeline

on:
  pull_request:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint-python:
    name: Lint Python Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Install pylint
        run: |
          uv pip install --system pylint
            
      - name: Lint Inference Engine
        run: |
          echo "::group::Linting Inference Engine"
          pylint backend/inference_engine/**/*.py --exit-zero || true
          pylint backend/inference_engine/**/*.py
          echo "::endgroup::"
        continue-on-error: false
      
      - name: Lint Migrations
        run: |
          echo "::group::Linting Migrations"
          pylint backend/migrations/**/*.py --exit-zero || true
          pylint backend/migrations/**/*.py
          echo "::endgroup::"
        continue-on-error: false

  lint-java:
    name: Lint Java (Hermes Backend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Make gradlew executable
        working-directory: ./backend/hermes
        run: chmod +x gradlew
      
      - name: Run Gradle checks
        working-directory: ./backend/hermes
        run: ./gradlew check --no-daemon

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run linter
        working-directory: ./frontend
        run: |
          # Add your frontend lint commands here
          # npm run lint
          echo "Add your frontend linting commands here"

  test-inference-engine:
    name: Test Inference Engine
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      
      - name: Set up Python
        run: uv python install 3.12
      
      - name: Install dependencies
        working-directory: ./backend/inference_engine
        run: uv sync

      - name: Install pytest-cov
        working-directory: ./backend/inference_engine
        run: uv pip install pytest-cov
      
      - name: Run pytest
        working-directory: ./backend/inference_engine
        run: |
          uv run pytest src/inference_engine/test_app.py -v --cov=src/inference_engine --cov-report=xml --cov-report=term
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./backend/inference_engine/coverage.xml
          flags: inference-engine
          fail_ci_if_error: false

  test-hermes:
    name: Test Hermes Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Make gradlew executable
        working-directory: ./backend/hermes
        run: chmod +x gradlew
      
      - name: Run tests
        working-directory: ./backend/hermes
        run: ./gradlew test --no-daemon
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hermes-test-results
          path: backend/hermes/build/reports/tests/

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run tests
        working-directory: ./frontend
        run: |
          # npm test -- --coverage
          echo "Add frontend test commands if available"

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint-frontend, test-inference-engine, test-frontend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify project structure
        run: |
          echo "Checking project structure..."
          ls -la
          echo "Backend structure:"
          ls -la backend/
          echo "Hermes structure:"
          ls -la backend/hermes/
          echo "Inference Engine structure:"
          ls -la backend/inference_engine/
          echo "Frontend structure:"
          ls -la frontend/

  build-hermes:
    name: Build Hermes Backend
    runs-on: ubuntu-latest
    needs: [build-verification]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Make gradlew executable
        working-directory: ./backend/hermes
        run: chmod +x gradlew
      
      - name: Build with Gradle
        working-directory: ./backend/hermes
        run: ./gradlew build -x test --no-daemon
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/hermes
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,format=short
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/hermes
          file: ./backend/hermes/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=hermes
          cache-to: type=gha,mode=max,scope=hermes
      
      - name: Output image details
        run: |
          echo "Hermes backend image pushed to GHCR:"
          echo "${{ steps.meta.outputs.tags }}"

  build-inference-engine:
    name: Build Inference Engine
    runs-on: ubuntu-latest
    needs: [build-verification]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/inference-engine
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,format=short
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/inference_engine
          file: ./backend/inference_engine/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=inference-engine
          cache-to: type=gha,mode=max,scope=inference-engine
      
      - name: Output image details
        run: |
          echo "Inference Engine image pushed to GHCR:"
          echo "${{ steps.meta.outputs.tags }}"

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [build-verification]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,format=short
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
      
      - name: Output image details
        run: |
          echo "Frontend image pushed to GHCR:"
          echo "${{ steps.meta.outputs.tags }}"

  build-data-handler:
    name: Build Data Handler
    runs-on: ubuntu-latest
    needs: [build-verification]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/data-handler
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,format=short
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/data_handler
          file: ./backend/data_handler/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=data-handler
          cache-to: type=gha,mode=max,scope=data-handler
      
      - name: Output image details
        run: |
          echo "Data Handler image pushed to GHCR:"
          echo "${{ steps.meta.outputs.tags }}"


  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-hermes, build-inference-engine, build-frontend, build-data-handler]
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "Hermes: ${{ needs.build-hermes.result }}"
          echo "Inference Engine: ${{ needs.build-inference-engine.result }}"
          echo "Frontend: ${{ needs.build-frontend.result }}"
          echo "Data Handler: ${{ needs.build-data-handler.result }}"
      
      - name: Generate summary
        run: |
          echo "## ðŸŽ‰ CI Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Images pushed to GHCR:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Hermes Backend | ${{ needs.build-hermes.result }} | \`ghcr.io/${{ github.repository }}/hermes:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Inference Engine | ${{ needs.build-inference-engine.result }} | \`ghcr.io/${{ github.repository }}/inference-engine:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.build-frontend.result }} | \`ghcr.io/${{ github.repository }}/frontend:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Handler | ${{ needs.build-data-handler.result }} | \`ghcr.io/${{ github.repository }}/data-handler:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Pull images with SHA:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}/hermes:sha-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}/inference-engine:sha-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}/frontend:sha-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}/data-handler:sha-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY