name: CI Pipeline

on:
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint-python:
    name: Lint Python Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            backend/inference_engine
            backend/data_handler

      - name: Check Data Handler (Linting)
        uses: astral-sh/ruff-action@v3
        with:
          args: "check --output-format=github"
          src: "./backend/data_handler"

      - name: Check Data Handler (Formatting)
        uses: astral-sh/ruff-action@v3
        with:
          args: "format --check"
          src: "./backend/data_handler"

      - name: Check Inference Engine (Linting)
        uses: astral-sh/ruff-action@v3
        with:
          args: "check --output-format=github"
          src: "./backend/inference_engine"
  
      - name: Check Inference Engine (Formatting)
        uses: astral-sh/ruff-action@v3
        with:
          args: "format --check"
          src: "./backend/inference_engine"

  test-data-handler:
    name: Test Data Handler
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            backend/data_handler
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          working-directory: ./backend/data_handler
      
      - name: Install Python
        working-directory: ./backend/data_handler
        run: uv python install
      
      - name: Install dependencies
        working-directory: ./backend/data_handler
        run: uv sync
      
      - name: Run pytest
        working-directory: ./backend/data_handler
        run: |
          uv run -m pytest

  test-inference-engine:
    name: Test Inference Engine
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            backend/inference_engine
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          working-directory: ./backend/inference_engine
      
      - name: Install Python
        working-directory: ./backend/inference_engine
        run: uv python install
      
      - name: Install dependencies
        working-directory: ./backend/inference_engine
        run: uv sync
      
      - name: Run pytest
        working-directory: ./backend/inference_engine
        env:
          HERMES_URL: http://localhost:8080
        run: |
          uv run -m pytest

  lint-and-test-java:
    name: Lint and Test Java Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            backend/hermes
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build and Lint (Error Prone)
        working-directory: ./backend/hermes
        run: ./gradlew build -x test -x spotlessCheck -x spotbugsMain --no-daemon
      
      - name: Run tests
        working-directory: ./backend/hermes
        run: ./gradlew test --no-daemon

      - name: Check Formatting (Spotless)
        working-directory: ./backend/hermes
        run: ./gradlew spotlessCheck --no-daemon

      # TODO: Reenable after fixing the spotbugs issues
      # - name: Run Static Analysis (Spotbugs)
      #   working-directory: ./backend/hermes
      #   run: ./gradlew spotbugsMain --no-daemon

  lint-frontend:
    name: Lint and Type Check Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
            sparse-checkout: |
              .github
              frontend
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml
      
      - name: Install dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Run Type Check
        working-directory: ./frontend
        run: pnpm run typecheck
      
      - name: Run linter
        working-directory: ./frontend
        run: pnpm run lint
      
      - name: Check formatting
        working-directory: ./frontend
        run: pnpm run format:check
